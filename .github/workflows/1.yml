name: Run 365.py for all txt files (loop)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [loop]

permissions:
  contents: write
  actions: write

jobs:
  prepare-input:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Unzip any zip file and flatten
        run: |
          mkdir -p input
          mkdir -p input_temp
          zip_file=$(ls *.zip | head -n 1)
          echo "Detected zip file: $zip_file"
          unzip -o "$zip_file" -d input_temp
          find input_temp -type f -name "*.txt" -exec mv {} input/ \;
          rm -rf input_temp
          ls -la input || true

      - name: Upload input files as artifact
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: input-txt
          path: input/

  discover-files:
    needs: prepare-input
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - name: Download input artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: input-txt
          path: input/

      - name: Normalize folder (if nested)
        run: |
          # å…œåº•ï¼šæœ‰æ—¶ä¼šå‡ºç° input/input/xxx.txt è¿™ç§åµŒå¥—
          if [ -d "input/input" ]; then
            find input/input -type f -name "*.txt" -exec mv {} input/ \; || true
            rm -rf input/input || true
          fi
          ls -la input || true

      - name: Find all txt files and build matrix
        id: set
        run: |
          files=$(find input -type f -name "*.txt" | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "FILES=$files"
          echo "matrix={\"file\":$files}" >> $GITHUB_OUTPUT

  run-script:
    needs: discover-files
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.discover-files.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Download input artifact
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: input-txt
          path: input/

      - name: Normalize folder (if nested)
        run: |
          if [ -d "input/input" ]; then
            find input/input -type f -name "*.txt" -exec mv {} input/ \; || true
            rm -rf input/input || true
          fi
          echo "Expecting file: ${{ matrix.file }}"
          ls -la input || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Prepare mail.txt and run script
        run: |
          if [ ! -f "${{ matrix.file }}" ]; then
            echo "Missing file: ${{ matrix.file }} (artifact download may have failed). Skip."
            exit 0
          fi
          cp "${{ matrix.file }}" mail.txt
          python 365.py mail.txt || true

      - name: Package per-job result (single file)
        run: |
          mkdir -p per_job_output
          timestamp=$(date +'%Y%m%d_%H%M%S')
          base=$(basename "${{ matrix.file }}" .txt)
          outfile="per_job_output/success_results_${base}_${timestamp}.txt"
          if [ -s success_results.txt ]; then
            cp success_results.txt "$outfile"
          else
            : > "$outfile"
          fi
          echo "OUTFILE=$outfile" >> $GITHUB_ENV
          echo "ARTIFACT_NAME=result-${base}-${timestamp}" >> $GITHUB_ENV

      - name: Upload per-job result
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.OUTFILE }}

  collect-results:
    if: always()
    needs: run-script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all per-job results
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Merge results and remove duplicates
        continue-on-error: true
        run: |
          mkdir -p merged_results
          timestamp=$(date +'%Y%m%d_%H%M%S')
          merged_file="merged_results/success_results_${timestamp}.txt"
          find all_results -type f -name "success_results_*.txt" -size +0c -exec cat {} + | sort -u > "$merged_file" || true
          echo "MERGED_FILE=$merged_file" >> $GITHUB_ENV
          ls -la merged_results || true

      - name: Commit merged results back
        continue-on-error: true
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add merged_results/ || true
          git commit -m "Add merged results ${{ env.MERGED_FILE }}" || true
          git push || true

      - name: Upload merged results
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: merged-results
          path: ${{ env.MERGED_FILE }}

      # ğŸ” æ¥åŠ›ï¼šdispatch + æ‰“å°çŠ¶æ€ç  + é‡è¯•ï¼ˆé¿å…â€œçœ‹èµ·æ¥æ²¡æ¥åŠ›â€ï¼‰
      - name: Trigger next run (dispatch with retry)
        if: always()
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sleep 120
          url="https://api.github.com/repos/${GITHUB_REPOSITORY}/dispatches"
          data='{"event_type":"loop"}'

          for i in 1 2 3 4 5; do
            code=$(curl -sS -o /tmp/dispatch_resp.txt -w "%{http_code}" \
              -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              "${url}" \
              -d "${data}" || true)

            echo "Dispatch attempt $i HTTP=$code"
            if [ "$code" = "204" ]; then
              echo "Dispatch success."
              exit 0
            fi

            echo "Dispatch failed response (if any):"
            cat /tmp/dispatch_resp.txt || true
            sleep $((i*20))
          done

          echo "Dispatch failed after retries (but keep workflow green)."
          exit 0
