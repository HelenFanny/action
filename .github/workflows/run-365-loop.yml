name: Run 365.py for all txt files (Auto Loop 10 Rounds)

on:
  workflow_dispatch:
    inputs:
      round:
        description: "Current round number"
        required: false
        default: "1"

jobs:
  prepare-input:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare input (use latest remaining or initial zip)
        run: |
          mkdir -p input
          # è‹¥ä»“åº“ä¸­å·²æœ‰ä¸Šè½® remaining æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨å®ƒ
          if ls merged_results/remaining_round_*.txt 1>/dev/null 2>&1; then
            latest=$(ls -t merged_results/remaining_round_*.txt | head -n 1)
            echo "ðŸ” Using previous remaining file: $latest"
            cp "$latest" input/
          elif ls *.zip 1>/dev/null 2>&1; then
            echo "ðŸ“¦ Using initial zip"
            mkdir -p input_temp
            zip_file=$(ls *.zip | head -n 1)
            unzip -o "$zip_file" -d input_temp
            find input_temp -type f -name "*.txt" -exec mv {} input/ \;
            rm -rf input_temp
          else
            echo "âŒ No zip or remaining file found"
            exit 1
          fi
          ls -R input

      - name: Upload input files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: input-txt
          path: input/

  discover-files:
    needs: prepare-input
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: input-txt
          path: input/

      - name: Find all txt files
        id: set
        run: |
          files=$(find input -type f -name "*.txt" | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix={\"file\":$files}" >> $GITHUB_OUTPUT

  run-script:
    needs: discover-files
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJSON(needs.discover-files.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: input-txt
          path: input/

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run script for file
        run: |
          base=$(basename "${{ matrix.file }}" .txt)
          cp "${{ matrix.file }}" mail.txt
          echo "â–¶ï¸ Running 365.py for $base"
          python 365.py mail.txt || true

          # å¦‚æžœç”Ÿæˆ success_results.txtï¼Œå°±ç§»é™¤æˆåŠŸè¡Œ
          if [ -s success_results.txt ]; then
            grep -vxFf success_results.txt mail.txt > remaining_${base}.txt || cp mail.txt remaining_${base}.txt
          else
            cp mail.txt remaining_${base}.txt
          fi

          mkdir -p per_job_output
          timestamp=$(date +'%Y%m%d_%H%M%S')
          cp success_results.txt "per_job_output/success_${base}_${timestamp}.txt" 2>/dev/null || touch "per_job_output/success_${base}_${timestamp}.txt"
          cp remaining_${base}.txt "per_job_output/remaining_${base}_${timestamp}.txt"

      - uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.file }}
          path: per_job_output/

  collect-results:
    needs: run-script
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: all_results

      - name: Merge and deduplicate
        run: |
          mkdir -p merged_results
          timestamp=$(date +'%Y%m%d_%H%M%S')
          round=${{ github.event.inputs.round }}
          merged_file="merged_results/success_round_${round}_${timestamp}.txt"
          remaining_file="merged_results/remaining_round_${round}_${timestamp}.txt"

          find all_results -type f -name "success_*.txt" -exec cat {} + | sort -u > "$merged_file" || true
          find all_results -type f -name "remaining_*.txt" -exec cat {} + | sort -u > "$remaining_file" || true

          echo "MERGED_FILE=$merged_file" >> $GITHUB_ENV
          echo "REMAINING_FILE=$remaining_file" >> $GITHUB_ENV
          echo "MERGED_TS=$timestamp" >> $GITHUB_ENV

      - name: Commit merged results
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add merged_results/
          git commit -m "Round ${{ github.event.inputs.round }} results merged at ${{ env.MERGED_TS }}" || echo "No changes"
          git push || true

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: merged-results-round-${{ github.event.inputs.round }}
          path: |
            ${{ env.MERGED_FILE }}
            ${{ env.REMAINING_FILE }}

      - name: Trigger next round (up to 10)
        if: ${{ github.event.inputs.round < 10 }}
        uses: peter-evans/workflow-dispatch@v1
        with:
          workflow: run-365-loop.yml
          ref: main
          inputs:
            round: ${{ github.event.inputs.round + 1 }}
