name: Run 365.py Loop (10 rounds)

on:
  workflow_dispatch:

jobs:
  run-loop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Initialize loop
        run: |
          echo "ROUND=1" > round.env
          echo "TOTAL=10" >> round.env
        shell: bash

      - name: Run 10 rounds sequentially
        run: |
          source round.env
          TOTAL=10

          for ((i=$ROUND; i<=$TOTAL; i++)); do
            echo "============================"
            echo "ðŸš€ Starting round $i"
            echo "============================"

            # è§£åŽ‹æˆ–å‡†å¤‡è¾“å…¥æ•°æ®
            if [ $i -eq 1 ]; then
              if [ -f input.zip ]; then
                mkdir -p input
                unzip -o input.zip -d input
                cat input/*.txt > input.txt
              fi
            fi

            # è‹¥å‰ä¸€è½®å·²ç”Ÿæˆå‰©ä½™æ–‡ä»¶ï¼Œåˆ™ç”¨å®ƒä½œä¸ºè¾“å…¥
            if [ -f remaining.txt ]; then
              mv remaining.txt input.txt
            fi

            # å¦‚æžœè¾“å…¥æ–‡ä»¶ä¸ºç©ºåˆ™åœæ­¢å¾ªçŽ¯
            if [ ! -s input.txt ]; then
              echo "âœ… No data left to process. Ending at round $i"
              break
            fi

            echo "Running 365.py..."
            python3 365.py || true

            echo "Removing processed lines..."
            if [ -f success.txt ]; then
              grep -vxFf success.txt input.txt > remaining.txt || cp input.txt remaining.txt
            else
              cp input.txt remaining.txt
            fi

            echo "Merging results..."
            cat success.txt >> all_success.txt 2>/dev/null || true
            sort -u all_success.txt -o all_success.txt

            echo "Committing results..."
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            git add all_success.txt remaining.txt
            git commit -m "Round $i completed"
            git push || true

            echo "Round $i completed, sleeping before next..."
            sleep 10
          done

          echo "ðŸŽ¯ All rounds completed!"
        shell: bash

      - name: Upload final results
        uses: actions/upload-artifact@v4
        with:
          name: final-results
          path: |
            all_success.txt
            remaining.txt
